<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CarShow360 - Removedor de Fondo</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        margin: 0;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .model-selector {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 12px;
      }

      .model-selector label {
        margin: 0 15px;
        font-weight: 600;
        cursor: pointer;
      }

      .model-selector input[type="radio"] {
        margin-right: 8px;
      }

      .status {
        text-align: center;
        padding: 10px;
        margin: 10px 0;
        border-radius: 8px;
        font-weight: 600;
      }

      .status.loading {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .status.ready {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin: 30px 0;
      }

      .preview {
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        padding: 25px;
        text-align: center;
        transition: transform 0.3s ease;
      }

      .preview:hover {
        transform: translateY(-5px);
      }

      .preview h2 {
        color: #555;
        margin-bottom: 20px;
        font-size: 1.4em;
      }

      canvas,
      img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .file-input-wrapper {
        text-align: center;
        margin: 30px 0;
      }

      .file-input-label {
        display: inline-block;
        padding: 15px 30px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border-radius: 50px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      .file-input-label:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      #fileInput {
        display: none;
      }

      .controls {
        margin-top: 30px;
        text-align: center;
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      button {
        padding: 12px 25px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      #fondoBlanco {
        background: linear-gradient(45deg, #f8f9fa, #e9ecef);
        color: #333;
      }

      #fondoNegro {
        background: linear-gradient(45deg, #343a40, #495057);
        color: white;
      }

      #fondoTransparente {
        background: linear-gradient(45deg, #17a2b8, #20c997);
        color: white;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
      }

      .processing {
        text-align: center;
        margin: 20px 0;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }

        .controls {
          flex-direction: column;
          align-items: center;
        }

        button {
          width: 200px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöó CarShow360 - Removedor de Fondo</h1>

      <div class="model-selector">
        <label>
          <input type="radio" name="model" value="bodypix" checked />
          BodyPix (Recomendado)
        </label>
        <label>
          <input type="radio" name="model" value="deeplab" />
          DeepLab (Veh√≠culos)
        </label>
      </div>

      <div id="status" class="status loading">Cargando modelo...</div>

      <div class="file-input-wrapper">
        <label for="fileInput" class="file-input-label">
          üì∏ Seleccionar Imagen
        </label>
        <input type="file" id="fileInput" accept="image/*" />
      </div>

      <div class="grid">
        <div class="preview">
          <h2>üì∑ Imagen Original</h2>
          <img id="originalImage" style="display: none" />
          <div id="originalPlaceholder" style="color: #999; padding: 60px 0">
            Selecciona una imagen para comenzar
          </div>
        </div>
        <div class="preview">
          <h2>‚ú® Sin Fondo</h2>
          <canvas id="resultCanvas" style="display: none"></canvas>
          <div id="resultPlaceholder" style="color: #999; padding: 60px 0">
            El resultado aparecer√° aqu√≠
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="fondoBlanco" disabled>ü§ç Fondo Blanco</button>
        <button id="fondoNegro" disabled>üñ§ Fondo Negro</button>
        <button id="fondoTransparente" disabled>‚ú® Transparente</button>
      </div>

      <div id="processing" class="processing" style="display: none">
        <div class="spinner"></div>
        <p>Procesando imagen...</p>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/deeplab"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.1"></script>

    <script>
      let bodyPixModel;
      let deeplabModel;
      let currentImage;
      let currentMask;
      let currentModel = "bodypix";

      const fileInput = document.getElementById("fileInput");
      const originalImage = document.getElementById("originalImage");
      const resultCanvas = document.getElementById("resultCanvas");
      const status = document.getElementById("status");
      const processing = document.getElementById("processing");
      const modelSelector = document.querySelectorAll('input[name="model"]');

      // Control de modelo seleccionado
      modelSelector.forEach((radio) => {
        radio.addEventListener("change", (e) => {
          currentModel = e.target.value;
          loadSelectedModel();
        });
      });

      async function loadSelectedModel() {
        try {
          status.className = "status loading";
          status.textContent = `Cargando modelo ${currentModel}...`;

          if (currentModel === "bodypix" && !bodyPixModel) {
            bodyPixModel = await bodyPix.load({
              architecture: "MobileNetV1",
              outputStride: 16,
              multiplier: 0.75,
              quantBytes: 2,
            });
          } else if (currentModel === "deeplab" && !deeplabModel) {
            deeplabModel = await deeplab.load({
              base: "pascal",
              quantizationBytes: 4,
            });
          }

          status.className = "status ready";
          status.textContent = `‚úÖ Modelo ${currentModel} listo`;
        } catch (error) {
          status.className = "status error";
          status.textContent = `‚ùå Error cargando modelo: ${error.message}`;
          console.error("Error loading model:", error);
        }
      }

      async function segmentWithBodyPix(img) {
        if (!bodyPixModel) throw new Error("Modelo BodyPix no cargado");

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const segmentation = await bodyPixModel.segmentPerson(imageData);

        const mask = new Uint8ClampedArray(segmentation.data.length);
        for (let i = 0; i < segmentation.data.length; i++) {
          // BodyPix: 1 = persona/objeto, 0 = fondo
          mask[i] = segmentation.data[i] === 1 ? 255 : 0;
        }

        return { mask, width: canvas.width, height: canvas.height };
      }

      async function segmentWithDeepLab(img) {
        if (!deeplabModel) throw new Error("Modelo DeepLab no cargado");

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const { segmentationMap } = await deeplabModel.segment(imageData);

        if (!segmentationMap) {
          throw new Error("No se pudo generar el mapa de segmentaci√≥n");
        }

        const mask = new Uint8ClampedArray(segmentationMap.length);
        // Para PASCAL VOC: car=7, bus=6, motorbike=14, bicycle=2, person=15
        const keepClasses = [2, 6, 7, 14, 15];

        for (let i = 0; i < segmentationMap.length; i++) {
          const shouldKeep = keepClasses.includes(segmentationMap[i]);
          mask[i] = shouldKeep ? 255 : 0;
        }

        return { mask, width: canvas.width, height: canvas.height };
      }

      function applyMaskToCanvas(
        img,
        mask,
        width,
        height,
        background = "transparent"
      ) {
        const canvas = resultCanvas;
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");

        // Fondo de color si no es transparente
        if (background !== "transparent") {
          ctx.fillStyle = background;
          ctx.fillRect(0, 0, width, height);
        } else {
          ctx.clearRect(0, 0, width, height);
        }

        // Dibujar imagen original
        ctx.drawImage(img, 0, 0, width, height);

        // Aplicar m√°scara
        const imageData = ctx.getImageData(0, 0, width, height);
        const data = imageData.data;

        for (let i = 0; i < mask.length; i++) {
          const alpha = mask[i];
          data[i * 4 + 3] = alpha; // Canal alpha
        }

        ctx.putImageData(imageData, 0, 0);
      }

      fileInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const imageUrl = URL.createObjectURL(file);
        const img = new Image();

        img.onload = async () => {
          try {
            // Mostrar imagen original
            originalImage.src = imageUrl;
            originalImage.style.display = "block";
            document.getElementById("originalPlaceholder").style.display =
              "none";

            // Mostrar indicador de procesamiento
            processing.style.display = "block";
            resultCanvas.style.display = "none";
            document.getElementById("resultPlaceholder").style.display = "none";

            // Deshabilitar botones
            document
              .querySelectorAll(".controls button")
              .forEach((btn) => (btn.disabled = true));

            currentImage = img;

            // Procesar seg√∫n el modelo seleccionado
            let result;
            if (currentModel === "bodypix") {
              result = await segmentWithBodyPix(img);
            } else {
              result = await segmentWithDeepLab(img);
            }

            currentMask = result;

            // Aplicar m√°scara y mostrar resultado
            applyMaskToCanvas(img, result.mask, result.width, result.height);

            // Mostrar canvas resultado
            processing.style.display = "none";
            resultCanvas.style.display = "block";

            // Habilitar botones
            document
              .querySelectorAll(".controls button")
              .forEach((btn) => (btn.disabled = false));
          } catch (err) {
            processing.style.display = "none";
            status.className = "status error";
            status.textContent = `‚ùå Error procesando: ${err.message}`;
            console.error("Error en procesamiento:", err);
          }
        };

        img.onerror = () => {
          processing.style.display = "none";
          status.className = "status error";
          status.textContent = "‚ùå No se pudo cargar la imagen";
        };

        img.src = imageUrl;
      });

      // Botones de fondo
      document.getElementById("fondoBlanco").onclick = () => {
        if (currentImage && currentMask) {
          applyMaskToCanvas(
            currentImage,
            currentMask.mask,
            currentMask.width,
            currentMask.height,
            "#ffffff"
          );
        }
      };

      document.getElementById("fondoNegro").onclick = () => {
        if (currentImage && currentMask) {
          applyMaskToCanvas(
            currentImage,
            currentMask.mask,
            currentMask.width,
            currentMask.height,
            "#000000"
          );
        }
      };

      document.getElementById("fondoTransparente").onclick = () => {
        if (currentImage && currentMask) {
          applyMaskToCanvas(
            currentImage,
            currentMask.mask,
            currentMask.width,
            currentMask.height,
            "transparent"
          );
        }
      };

      // Cargar modelo inicial
      loadSelectedModel();
    </script>
  </body>
</html>
